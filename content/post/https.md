---
title: "HTTPS"
date: 2019-12-22T08:39:02+08:00
draft: true
categories: ["技术"]
tags: ["https"]
---
春风虽欲重回首，落花不再上枝头。——《菜根谭》
<!--more-->
# 简述
随着网络的发展和普及，人们将越来也多的事物迁移到Web服务上来处理，这时网络安全就需要强有力的安全保障。HTTPS是HTTP的安全版本，通过将HTTP和数字加密技术结合，使得网络访问更加安全可靠。  

构建安全可靠的Web服务需要满足如下要求:  

## 认证
* 客户端对服务端的认证  
客户端要能够鉴定是不是在和真正的服务端通信，而不是伪造的服务端   
* 服务端对客户端的认证  
服务端也需要能够鉴定是不是在和真正的客户端通信，而不是伪造的客户端   

因为通信涉及客户端和服务端，而这两端都可以被冒称，和现实生活中类似，任一一端假冒，都可能使另外一方蒙受损失，因此要有办法相互认证。

## 通信
* 完整性  
客户端和服务端之间的通信的数据不会被修改
* 加密  
客户端和服务器的对话是私密的，无需担心被窃听
* 效率  
一个运行足够快的算法，以便客户端和服务器能够高效使用  

总的来说，就是客户端和服务端之间的通信要具备完整性，还要既安全，又高效

## 其它
* 普适性(基本上所有的客户端和服务器都支持这些协议)
* 管理的可扩展性(在任何地方的任何人都可以立即进行安全通信)
* 适应性(能够支持当前最知名的安全方法)
* 在社会上的可行性(满足社会的政治文化需要)


# 术语简述
## 密钥
改变密码编解码行为的数字化参数

## 公钥和私钥   
公钥和私钥是一对，配对使用，都可以加解密，公私钥也只是相对的一个称呼。通常公开的密钥叫公钥，只有自己知道的叫私钥。  

使用公钥私钥加解密基于如下规则:    
1. 用公钥加密的数据只有对应的私钥可以解密  
2. 用私钥加密的数据只有对应的公钥可以解密  
3. 如果数据可以用公钥解密，则必然是对应的私钥加的密  
4. 如果数据可以用私钥解密，则必然是对应的公钥加的密。

通常我们用公钥加密，私钥解密，确保发送的信息只有有“私钥拥有者” 能够解密。反之，如果用私钥加密传递数据，则会被公钥持有者(公钥公开)解密，就失去了对信息的保护

## 对称加密(私钥加密)   
对称加密也叫私钥加密，加密时使用的密钥相同，也正因为同一密钥即用于加密也用于解密，因为密钥不可以公开。  

对称加密的优点是加解密速度快，缺点安全性相对较低，另外，每一对客户端/服务端通信双方需要持有一个共同的密钥，同时基于安全考虑，密钥又不能相互传输，密钥管理成本大

## 非对称加密(公钥加密) 
非对称加密也叫公钥加密，编解码时使用的密钥不同，一个是公钥，一个是私钥。通常我们在接收方生产公钥私钥对，接收方将公钥发送给发送方，公钥嘛，传输途中被泄露无关紧要，发送方收到公钥后，用公钥进行加密数据再发送给接收方，接收方收到数据后用自己的私钥解密。

由于公钥加密的数据必须用对应的私钥才能解密，而私钥又只有接收方自己知道，这样就保证了数据传输的安全性。

非对称加密的优点就是安全性高，但效率没有对称加密速度快

## 公开密钥加密 
一种能够能使数百万计算机便捷地发送机密报文的算法，因为它没有对每对客户端/服务端使用单独的加密解密密钥，而是使用两个非对称密钥，密钥管理成本大幅降低。任何人只要知道公钥，便可以向公共服务器发出安全报文，两个节点无须为了进行安全的通信而先交换私有密钥。

## 混合加密 
公开密钥加密算法的计算可能会很慢，因此通常混合使用对称和非对称加密，常见的做法就是先在两节点间通过便捷的公开密钥加密技术建立起安全通信，然后再用那条安全的通道产生并发送临时的随机对称密钥，通过更快的对称加密技术对其余的数据进行加密

## 数字签名(digital signing): 
数字签名是附加在报文上的特殊加密校验码，用来验证报文是否被伪造或篡改的校验和，也就是确保数据的完整性。数字签名使用非对称公开密钥技术产生，数据发送者使用私钥进行签名，数据接受者使用公钥来验证。因为用公钥可以解密的必然是用对应的私钥加的密，这样一可以保证数据来自可靠的发送者，二验证数据的完整性。

## 数字证书
一个可信的组织验证和签发的识别信息


## 数字证书
数字证书就像因特网上的ID卡，证书中包含用户或公司的相关信息，该用户或公司受某个可信组织担保，证书也由其签发。

# 工作原理
HTTPS整个过程分为证书验证和数据传输两个阶段。HTTPS协议之所以更安全，就是因为HTTPS协议会对证书验证和传输数据进行加密，其中证书验证使用的是非对称加密，而内容传输使用的是对称加密。先了解下本文涉及的术语


## 证书验证
1. 浏览器发起HTTPS请求
2. 服务端返回HTTPS证书(含公钥)
3. 客户端验证证书是否合法，不合法提示警告  

## 数据传输阶段
1. 证书验证合法后，在本地生成随机数
2. 通过公钥加密随机数，并把加密后的随机数传输到服务端
3. 服务端通过私钥对随机数进行解密
4. 服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输

## 为什么数据传输是用对称加密？
非对称加密的加解密效率是非常低的，而 http 的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的

另外，在 HTTPS 的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以 HTTPS 中内容传输加密采取的是对称加密，而不是非对称加密。


## 为什么需要 CA 认证机构颁发证书？
HTTP 协议被认为不安全是因为传输过程容易被监听者勾线监听、伪造服务器，而 HTTPS 协议主要解决的便是网络传输的安全性问题。

首先我们假设不存在认证机构，任何人都可以制作证书，这带来的安全风险便是经典的“中间人攻击”问题。

“中间人攻击”的具体过程如下：
过程原理：

本地请求被劫持（如DNS劫持等），所有请求均发送到中间人的服务器
中间人服务器返回中间人自己的证书
客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输
中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密
中间人以客户端的请求内容再向正规网站发起请求
因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据
中间人凭借与正规网站建立的对称加密算法对内容进行解密
中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输
客户端通过与中间人建立的对称加密算法对返回结果数据进行解密
由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取。



# 浏览器是如何确保 CA 证书的合法性
1. 证书包含什么信息？
颁发机构信息
公钥
公司信息
域名
有效期
指纹
......
2. 证书的合法性依据是什么？
首先，权威机构是要有认证的，不是随便一个机构都有资格颁发证书，不然也不叫做权威机构。另外，证书的可信性基于信任制，权威机构需要对其颁发的证书进行信用背书，只要是权威机构生成的证书，我们就认为是合法的。所以权威机构会对申请者的信息进行审核，不同等级的权威机构对审核的要求也不一样，于是证书也分为免费的、便宜的和贵的。

3. 浏览器如何验证证书的合法性？
浏览器发起 HTTPS 请求时，服务器会返回网站的 SSL 证书，浏览器需要对证书做以下验证：

验证域名、有效期等信息是否正确。证书上都有包含这些信息，比较容易完成验证；
判断证书来源是否合法。每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证；


判断证书是否被篡改。需要与 CA 服务器进行校验；
判断证书是否已吊销。通过CRL（Certificate Revocation List 证书注销列表）和 OCSP（Online Certificate Status Protocol 在线证书状态协议）实现，其中 OCSP 可用于第3步中以减少与 CA 服务器的交互，提高验证效率
以上任意一步都满足的情况下浏览器才认为证书是合法的。

这里插一个我想了很久的但其实答案很简单的问题：
既然证书是公开的，如果要发起中间人攻击，我在官网上下载一份证书作为我的服务器证书，那客户端肯定会认同这个证书是合法的，如何避免这种证书冒用的情况？
其实这就是非加密对称中公私钥的用处，虽然中间人可以得到证书，但私钥是无法获取的，一份公钥是不可能推算出其对应的私钥，中间人即使拿到证书也无法伪装成合法服务端，因为无法对客户端传入的加密数据进行解密。

4. 只有认证机构可以生成证书吗？
如果需要浏览器不提示安全风险，那只能使用认证机构签发的证书。但浏览器通常只是提示安全风险，并不限制网站不能访问，所以从技术上谁都可以生成证书，只要有证书就可以完成网站的 HTTPS 传输。例如早期的 12306 采用的便是手动安装私有证书的形式实现 HTTPS 访问。


本地随机数被窃取怎么办？
证书验证是采用非对称加密实现，但是传输过程是采用对称加密，而其中对称加密算法中重要的随机数是由本地生成并且存储于本地的，HTTPS 如何保证随机数不会被窃取？

其实 HTTPS 并不包含对随机数的安全保证，HTTPS 保证的只是传输过程安全，而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。


用了 HTTPS 会被抓包吗？
HTTPS 的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。

但是，正如前文所说，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。因此，只要客户端是我们自己的终端，我们授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。通常 HTTPS 抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互，然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。

既然 HTTPS 不能防抓包，那 HTTPS 有什么意义？
HTTPS 可以防止用户在不知情的情况下通信链路被监听，对于主动授信的抓包操作是不提供防护的，因为这个场景用户是已经对风险知情。要防止被抓包，需要采用应用级的安全防护，例如采用私有的对称加密，同时做好移动端的防反编译加固，防止本地算法被破解。

总结

以下用简短的Q&A形式进行全文总结：

Q: HTTPS 为什么安全？
A: 因为 HTTPS 保证了传输安全，防止传输过程被监听、防止数据被窃取，可以确认网站的真实性。

Q: HTTPS 的传输过程是怎样的？
A: 客户端发起 HTTPS 请求，服务端返回证书，客户端对证书进行验证，验证通过后本地生成用于改造对称加密算法的随机数，通过证书中的公钥对随机数进行加密传输到服务端，服务端接收后通过私钥解密得到随机数，之后的数据交互通过对称加密算法进行加解密。

Q: 为什么需要证书？
A: 防止”中间人“攻击，同时可以为网站提供身份证明。

Q: 使用 HTTPS 会被抓包吗？
A: 会被抓包，HTTPS 只防止用户在不知情的情况下通信被监听，如果用户主动授信，是可以构建“中间人”网络，代理软件可以对传输内容进行解密。

{{< highlight go "linenos=inline" >}}
{{< /highlight >}}

# 参考
[理解公钥与私钥](https://songlee24.github.io/2015/05/03/public-key-and-private-key/)
